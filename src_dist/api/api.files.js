let path=require("path"),fs=require("fs"),v4=require("uuid").v4,UserModel=require("../model/user").UserModel,ResponseModel=require("../model/response").ResponseModel,util=require("util");function GetUserDirectoryPath(e){return path.join(__dirname,"../..",process.env.FILE_DIRECTORY_NAME,e)}function DirectoryInquiry(e){return new Promise((i,n)=>{fs.readdir(e,(e,r)=>{e?n(e):i(r)})})}function FileToItem(e){var r=Buffer.from(e.name,"latin1").toString("utf8");return{fileName:v4()+(new Date).getTime()+path.extname(r),originName:r,type:e.mimetype}}async function FileUpload(o,t){try{if(!o||!t)return new ResponseModel(403,null,"id, files null");var l=path.join(__dirname,"../..",process.env.FILE_DIRECTORY_NAME,o),a=[];if(Array.isArray(t)){for(let r=0;r<t.length;r++){let e=t[r];var s=FileToItem(e);let i=path.join(l,s.fileName),n={id:o,...s};var u=new Promise(r=>{e.mv(i,e=>{r(e?{isFail:!0,...n}:n)})});a.push(await u)}return new ResponseModel(200,a)}{var r=FileToItem(t);let e=path.join(l,r.fileName),i={id:o,...r};var n=new Promise(r=>{t.mv(e,e=>{r(e?{isFail:!0,...i}:i)})});return a.push(await n),new ResponseModel(200,a)}}catch(e){throw new ResponseModel(500,e,"FileUpload api 에서 알수없는 에러")}}async function ProfileUpload(n,o){try{if(!n||!o)return new ResponseModel(403,null,"id, file null");var r=path.join(GetUserDirectoryPath(n),"profile"),t=await DirectoryInquiry(r);if(0<t.length)for(let e=0;e<t.length;e++){var l=path.join(r,t[e]);await fs.unlinkSync(l)}let i=FileToItem(o),e=path.join(r,i.fileName);return new Promise(r=>{o.mv(e,e=>{if(e)return r(new ResponseModel(403,e,"파일업로드 실패"));r(new ResponseModel(200,{...i,id:n}))})})}catch(e){console.log(e,"err")}}module.exports={FileUpload:FileUpload,ProfileUpload:ProfileUpload};// build date : 2025. 5. 21. 오후 7:06:44